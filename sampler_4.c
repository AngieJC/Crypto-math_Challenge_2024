/*
 * @Author: AngieJC htk90uggk@outlook.com
 * @Date: 2024-05-06 22:34:47
 * @LastEditors: AngieJC htk90uggk@outlook.com
 * @LastEditTime: 2024-05-10 11:53:14
 * @FilePath: /Crypto-math_Challenge_2024/sampler_4.c
 */
#include "my_sampler.h"

static int sampler_base_4(prng *__restrict rng){
    static const uint8_t m4_index[56][10] = {
        {3, 0, 0, 0, 0, 0, 0, 0, 0, 0}, {2, 6, 0, 0, 0, 0, 0, 0, 0, 0}, {1, 3, 4, 6, 0, 0, 0, 0, 0, 0}, 
        {2, 4, 5, 0, 0, 0, 0, 0, 0, 0}, {0, 3, 4, 5, 7, 0, 0, 0, 0, 0}, {1, 2, 3, 5, 6, 7, 0, 0, 0, 0}, 
        {4, 5, 6, 7, 0, 0, 0, 0, 0, 0}, {2, 4, 6, 8, 0, 0, 0, 0, 0, 0}, {1, 4, 7, 8, 0, 0, 0, 0, 0, 0}, 
        {1, 2, 3, 4, 0, 0, 0, 0, 0, 0}, {4, 5, 6, 0, 0, 0, 0, 0, 0, 0}, {2, 3, 4, 5, 9, 0, 0, 0, 0, 0}, 
        {0, 1, 2, 3, 5, 9, 0, 0, 0, 0}, {0, 2, 6, 9, 0, 0, 0, 0, 0, 0}, {7, 8, 0, 0, 0, 0, 0, 0, 0, 0}, 
        {1, 2, 5, 6, 9, 0, 0, 0, 0, 0}, {1, 2, 3, 4, 5, 6, 7, 9, 0, 0}, {0, 4, 6, 7, 8, 0, 0, 0, 0, 0}, 
        {0, 1, 2, 3, 4, 5, 6, 8, 9, 0}, {0, 3, 7, 8, 9, 0, 0, 0, 0, 0}, {5, 6, 7, 8, 9, 0, 0, 0, 0, 0}, 
        {3, 4, 7, 8, 9, 0, 0, 0, 0, 0}, {0, 1, 3, 6, 8, 0, 0, 0, 0, 0}, {0, 4, 5, 7, 8, 0, 0, 0, 0, 0}, 
        {0, 3, 6, 7, 9, 0, 0, 0, 0, 0}, {1, 2, 3, 4, 9, 0, 0, 0, 0, 0}, {0, 1, 2, 3, 6, 0, 0, 0, 0, 0}, 
        {1, 4, 5, 6, 7, 9, 0, 0, 0, 0}, {0, 2, 9, 0, 0, 0, 0, 0, 0, 0}, {3, 5, 6, 8, 0, 0, 0, 0, 0, 0}, 
        {2, 3, 4, 5, 6, 8, 9, 0, 0, 0}, {0, 3, 5, 7, 9, 0, 0, 0, 0, 0}, {0, 1, 3, 4, 6, 8, 0, 0, 0, 0}, 
        {5, 6, 7, 0, 0, 0, 0, 0, 0, 0}, {0, 1, 2, 6, 7, 0, 0, 0, 0, 0}, {0, 2, 3, 4, 5, 0, 0, 0, 0, 0}, 
        {1, 2, 5, 9, 0, 0, 0, 0, 0, 0}, {0, 2, 3, 4, 5, 7, 8, 9, 0, 0}, {1, 3, 4, 5, 0, 0, 0, 0, 0, 0}, 
        {0, 8, 0, 0, 0, 0, 0, 0, 0, 0}, {0, 2, 3, 4, 5, 7, 8, 9, 0, 0}, {1, 9, 0, 0, 0, 0, 0, 0, 0, 0}, 
        {0, 2, 3, 4, 5, 7, 9, 0, 0, 0}, {1, 4, 5, 7, 8, 9, 0, 0, 0, 0}, {0, 1, 9, 0, 0, 0, 0, 0, 0, 0}, 
        {0, 2, 3, 4, 5, 7, 8, 0, 0, 0}, {5, 6, 7, 8, 0, 0, 0, 0, 0, 0}, {3, 4, 5, 7, 0, 0, 0, 0, 0, 0}, 
        {7, 8, 9, 0, 0, 0, 0, 0, 0, 0}, {5, 7, 8, 0, 0, 0, 0, 0, 0, 0}, {0, 0, 0, 0, 0, 0, 0, 0, 0, 0}, 
        {0, 0, 0, 0, 0, 0, 0, 0, 0, 0}, {7, 8, 0, 0, 0, 0, 0, 0, 0, 0}, {6, 8, 9, 0, 0, 0, 0, 0, 0, 0}, 
        {7, 0, 0, 0, 0, 0, 0, 0, 0, 0}, {9, 0, 0, 0, 0, 0, 0, 0, 0, 0}
    };
    static const uint8_t m4_col_sum[56] = {
        1, 2, 4, 3, 5, 6, 4, 4, 
        4, 4, 3, 5, 6, 4, 2, 5, 
        8, 5, 9, 5, 5, 5, 5, 5, 
        5, 5, 5, 6, 3, 4, 7, 5, 
        6, 3, 5, 5, 4, 8, 4, 2, 
        8, 2, 7, 6, 3, 7, 4, 4, 
        3, 3, 0, 0, 2, 3, 1, 1
    };
    static const int8_t sample_val[254] = {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 
        3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 
        3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5
    };
    static uint64_t b64 = 0, cnt = 0;
    int32_t d = prng_get_u8(rng);
    while(1) {
        if(__glibc_likely(d < 254))
            return sample_val[d];
        d &= 1;
        for(int col = 0; col < 56; ++col) {
            d = (d << 1) + check_cnt(&cnt, &b64, rng) - m4_col_sum[col];
            if(d < 0)
                return m4_index[col][-(d + 1)];
        }
    }
    return 0;
}

static double my_exp(double x) {
    if(x < -0.6931471805599453) {
        double y = my_exp(x * 0.5);
        return y * y;
    }
    double p = 1 + x + 0.5 * x * x + 
            0.16666666658538531 * x * x * x + 
            0.041666667747152886 * x * x * x * x + 
            0.008333325351663756 * x * x * x * x * x + 
            0.001388924568049621 * x * x * x * x * x * x + 
            0.00019831243191621023 * x * x * x * x * x * x * x +
            2.4979316805525884e-05 * x * x * x * x * x * x * x * x + 
            2.564104613920104e-06 * x * x * x * x * x * x * x * x * x +
            3.8819594624219325e-07 * x * x * x * x * x * x * x * x * x * x;
    return p;
}

inline static int accept_sample(double x, double sigma, prng *__restrict rng) {
    double p = (0.8 / sigma) * my_exp(x);
    uint64_t i = 1;
    uint8_t u, v;
    do {
        i <<= 8;
        u = prng_get_u8(rng);
        v = (uint64_t)(p * i) & 0xff;
    } while (u == v);
    return u < v;    
}

// sigma is uniformly distributed over (0.8,1.6) and center is uniformly distributed over [0,1)
int sampler_4(void *ctx, double sigma, double center){
    prng *restrict rng = &((sampler_context *)ctx)->p;
    static uint64_t b64 = 0, cnt = 0;
    static double subtracted_numbers[] = {0.0, 0.15086504887537272, 0.6034601955014909, 1.3577854398783544, 2.4138407820059635, 3.771626221884318, 5.431141759513418, 7.392387394893263, 9.655363128023854, 12.220068958905191};

    while(1) {
        uint8_t z0 = sampler_base_4(rng);
        int8_t z = check_cnt(&cnt, &b64, rng) ? z0 + 1 : -z0;
        double x = subtracted_numbers[z0]
                    - (double)((z - center) * (z - center)) / (2 * sigma * sigma);
        if(accept_sample(x, sigma, rng))
            return z;
    }

    return 0;
}
