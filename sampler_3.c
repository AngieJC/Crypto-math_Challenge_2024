/*
 * @Author: AngieJC htk90uggk@outlook.com
 * @Date: 2024-05-06 22:34:47
 * @LastEditors: AngieJC htk90uggk@outlook.com
 * @LastEditTime: 2024-05-14 20:24:07
 * @FilePath: /Crypto-math_Challenge_2024/sampler_3.c
 */
#include "my_sampler.h"

static int sampler_base_3(prng *__restrict rng){
    static const uint8_t m3_index[56][10] = {
        {0, 3, 0, 0, 0, 0, 0, 0, 0, 0}, {5, 0, 0, 0, 0, 0, 0, 0, 0, 0}, {1, 2, 5, 0, 0, 0, 0, 0, 0, 0}, 
        {0, 2, 4, 0, 0, 0, 0, 0, 0, 0}, {2, 3, 5, 6, 0, 0, 0, 0, 0, 0}, {3, 0, 0, 0, 0, 0, 0, 0, 0, 0}, 
        {3, 4, 5, 0, 0, 0, 0, 0, 0, 0}, {1, 6, 0, 0, 0, 0, 0, 0, 0, 0}, {2, 3, 4, 7, 0, 0, 0, 0, 0, 0}, 
        {0, 1, 5, 0, 0, 0, 0, 0, 0, 0}, {0, 1, 3, 5, 6, 0, 0, 0, 0, 0}, {0, 1, 2, 4, 5, 6, 0, 0, 0, 0}, 
        {1, 6, 0, 0, 0, 0, 0, 0, 0, 0}, {0, 2, 3, 4, 5, 6, 8, 0, 0, 0}, {0, 1, 3, 4, 7, 0, 0, 0, 0, 0}, 
        {0, 3, 4, 7, 0, 0, 0, 0, 0, 0}, {0, 1, 2, 3, 4, 6, 7, 8, 0, 0}, {1, 3, 4, 6, 0, 0, 0, 0, 0, 0}, 
        {0, 5, 8, 0, 0, 0, 0, 0, 0, 0}, {0, 3, 7, 8, 9, 0, 0, 0, 0, 0}, {2, 3, 4, 5, 6, 9, 0, 0, 0, 0}, 
        {0, 2, 4, 0, 0, 0, 0, 0, 0, 0}, {1, 5, 7, 9, 0, 0, 0, 0, 0, 0}, {1, 4, 5, 6, 8, 9, 0, 0, 0, 0}, 
        {0, 1, 4, 6, 8, 0, 0, 0, 0, 0}, {1, 2, 4, 6, 7, 9, 0, 0, 0, 0}, {0, 1, 2, 3, 4, 5, 6, 7, 9, 0}, 
        {0, 1, 2, 4, 5, 7, 8, 9, 0, 0}, {0, 1, 3, 4, 5, 9, 0, 0, 0, 0}, {0, 2, 4, 6, 7, 8, 9, 0, 0, 0}, 
        {0, 1, 3, 5, 6, 8, 0, 0, 0, 0}, {5, 7, 0, 0, 0, 0, 0, 0, 0, 0}, {2, 3, 4, 6, 7, 0, 0, 0, 0, 0}, 
        {0, 2, 3, 4, 5, 6, 8, 0, 0, 0}, {2, 3, 4, 5, 6, 7, 8, 0, 0, 0}, {0, 1, 2, 3, 4, 5, 6, 7, 8, 0}, 
        {0, 2, 6, 8, 0, 0, 0, 0, 0, 0}, {1, 3, 4, 6, 7, 8, 9, 0, 0, 0}, {0, 1, 4, 5, 6, 9, 0, 0, 0, 0}, 
        {1, 2, 3, 8, 0, 0, 0, 0, 0, 0}, {2, 5, 7, 9, 0, 0, 0, 0, 0, 0}, {0, 2, 4, 7, 0, 0, 0, 0, 0, 0}, 
        {0, 1, 9, 0, 0, 0, 0, 0, 0, 0}, {1, 2, 3, 4, 7, 8, 9, 0, 0, 0}, {2, 8, 0, 0, 0, 0, 0, 0, 0, 0}, 
        {1, 2, 3, 5, 9, 0, 0, 0, 0, 0}, {6, 8, 9, 0, 0, 0, 0, 0, 0, 0}, {3, 7, 8, 0, 0, 0, 0, 0, 0, 0}, 
        {4, 5, 6, 7, 9, 0, 0, 0, 0, 0}, {5, 7, 8, 0, 0, 0, 0, 0, 0, 0}, {5, 6, 7, 9, 0, 0, 0, 0, 0, 0}, 
        {5, 8, 9, 0, 0, 0, 0, 0, 0, 0}, {6, 8, 9, 0, 0, 0, 0, 0, 0, 0}, {7, 8, 0, 0, 0, 0, 0, 0, 0, 0}, 
        {6, 9, 0, 0, 0, 0, 0, 0, 0, 0}, {7, 8, 0, 0, 0, 0, 0, 0, 0, 0}
    };
    static const uint8_t m3_col_sum[56] = {
        2, 1, 3, 3, 4, 1, 3, 2, 
        4, 3, 5, 6, 2, 7, 5, 4, 
        8, 4, 3, 5, 6, 3, 4, 6, 
        5, 6, 9, 8, 6, 7, 6, 2, 
        5, 7, 7, 9, 4, 7, 6, 4, 
        4, 4, 3, 7, 2, 5, 3, 3, 
        5, 3, 4, 3, 3, 2, 2, 2
    };
    static const int8_t sample_val[254] = {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
        1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 
        3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4
    };
    static uint64_t b64 = 0, cnt = 0;
    int32_t d;
    while(1) {
        uint8_t b8 = prng_get_u8(rng);
        if(__glibc_likely(b8 < 254))
            return sample_val[b8];
        b8 = ~b8;
        d = b8;
        #if defined __GNUC__
        #pragma GCC unroll 2
        #elif defined __clang__
        #pragma clang loop unroll(2)
        #endif
        for(int col = 0; col < 56; ++col) {
            d = (d << 1) + check_cnt(&cnt, &b64, rng) - m3_col_sum[col];
            if(d < 0)
                return m3_index[col][-(d + 1)];
        }
    }
}

inline double my_exp(double x) {
    uint32_t cnt = 1;
    while(x < -0.8) {
        x *= 0.5;
        cnt <<= 1;
    }
    double p = 1 + x + 0.5 * x * x + 
            0.16666666666666666 * x * x * x + 
            0.041666666666666664 * x * x * x * x + 
            0.008333333333333333 * x * x * x * x * x + 
            0.001388888888888889 * x * x * x * x * x * x; // + 
            // 0.0001984126984126984 * x * x * x * x * x * x * x; // + 
            // 2.48015873015873e-05 * x * x * x * x * x * x * x * x; // + 
            // 2.7557319223985893e-06 * x * x * x * x * x * x * x * x * x; // + 
            // 2.755731922398589e-07 * x * x * x * x * x * x * x * x * x * x;
    while(cnt > 1) {
        p *= p;
        cnt >>= 1;
    }
    return p;
}

inline static int accept_sample(double p, prng *__restrict rng) {
    uint64_t i = 1;
    uint8_t u, v;
    do {
        i <<= 8;
        u = prng_get_u8(rng);
        v = (uint64_t)(p * i) & 0xff;
    } while (__glibc_unlikely(u == v));
    return u < v;
}

// Fixed sigma = 1.5 and center c is uniformly distributed over [0,1)
int sampler_3(void *ctx, double center){
    prng *restrict rng = &((sampler_context *)ctx)->p;
    static double subtracted_numbers[] = {0.0, 0.2222222222222222, 0.8888888888888888, 2.0, 3.5555555555555554, 5.555555555555555, 8.0, 10.88888888888889, 14.222222222222221, 18.0};

    while(1) {
        uint8_t z0 = sampler_base_3(rng);
        int8_t z = (prng_get_u8(rng) & 1) ? z0 + 1 : -z0;
        double x = subtracted_numbers[z0]
                    - (double)((z - center) * (z - center)) / (2 * 1.5 * 1.5);
        if((x == 0) || accept_sample(my_exp(x), rng))
            return z;
    }

    return 0;
}
